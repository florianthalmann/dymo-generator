function DymoGenerator(a,c,b){function e(a,h){var d=n.addDymo(a),c=h.getFeatures(),b;for(b in c)n.setDymoFeature(d,k(b),c[b]);n.setDymoFeature(d,k("level"),h.getLevel());c=h.getParts();for(b=0;b<c.length;b++)e(d,c[b])}function d(a){t=l.toJsonHierarchyGraph();v=l.toJsonSimilarityGraph();if(a){var d=a.toFlatJson();h[a.getUri()]=a;y[a.getUri()]=d;for(d=0;d<r.length;d++)g(a,r[d])}b&&b()}function g(a,h){var d=a.getFeature(h.name);if(!isNaN(d))m(h,d);else if(d instanceof Array)for(var b=0;b<d.length;b++)m(h,
d[b])}function m(a,h){void 0==a.max?(a.min=h,a.max=h):(a.min=Math.min(h,a.min),a.max=Math.max(h,a.max))}function p(a){var h=[];if(0<a.length){for(var d=a[0].value.length,b=0;b<d;b++)if(w==FIRST)h[b]=a[0].value[b];else if(w==MEAN)h[b]=a.reduce(function(a,h){return a+h.value[b]},0)/a.length;else if(w==MEDIAN){a.sort(function(a,h){return a.value[b]-h.value[b]});var c=Math.floor(a.length/2);h[b]=a[c].value[b];0==a.length%2&&(h[b]+=a[c-1].value[b])}return 1==h.length?h[0]:h}return 0}function k(a){for(var h=
0;h<r.length;h++)if(r[h].name==a)return r[h];a=f(a);r.splice(r.length-2,0,a);c(a);return a}function f(a,h,b){return void 0!=h&&void 0!=b?{name:a,min:h,max:b}:{name:a,min:1E3,max:0}}var n=this,l,q,u,t,v,h,y,r,x,w=MEAN,z;this.resetDymo=function(){q=l=void 0;u=!1;t={nodes:[],links:[]};v={nodes:[],links:[]};h={};y={};r=[f("level"),f("random",0,1)];x=0};this.setDymo=function(a,h){this.resetDymo();e(void 0,a)};this.getDymo=function(){return l};this.getDymoGraph=function(){return t};this.getSimilarityGraph=
function(){return v};this.getFeatures=function(){return r};this.setCondensationMode=function(a){w=a};this.setCurrentSourcePath=function(a){z=a};this.getScheduler=function(){return a};this.getRealDymo=function(a){return h[a["@id"]]};this.setAudioFileChanged=function(){u=!0;if(l){var b=new DynamicMusicObject("dymo"+Object.keys(h).length,a,PARALLEL);b.addPart(l);l=b;d(l)}};this.addDymo=function(b,c){b&&b.getUri();var e=new DynamicMusicObject("dymo"+Object.keys(h).length,a);l||(l=e);b&&b.addPart(e);c&&
e.setSourcePath(c);d(e);return e};this.addFeature=function(a,h,b){a=k(a);for(b=0;b<t.nodes.length;b++){var c=t.nodes[b].time.value,e=t.nodes[b].duration.value,f=h.filter(function(a){return c<=a.time.value&&a.time.value<c+e});1>f.length&&(f=h.filter(function(a){return a.time.value<c}),f=f[f.length-1]);f=p(f);this.setDymoFeature(this.getRealDymo(t.nodes[b]),a,f)}d()};this.addSegmentation=function(a){0==Object.keys(h).length?q=this.addDymo(void 0,z):u&&(q=this.addDymo(l,z),x=q.getLevel(),u=!1);for(var b=
0;b<a.length;b++){var c;a:{c=a[b].time.value;for(var e=q,f=q.getLevel();f<x;){var r=e.getParts();if(0<r.length){for(var g=0;g<r.length;g++)if(r[g].getFeature("time")<=c)e=r[g];else if(0==g)e=r[g];else break;f++}else{c=e;break a}}c=e}var f=a[b].time.value,k;a[b].duration?k=a[b].duration.value:a[b+1]?k=a[b+1].time.value-f:c.getFeature("time")&&c.getFeature("duration")&&(k=c.getFeature("time")+c.getFeature("duration")-f);0<k&&(e=this.addDymo(c),this.setDymoFeature(e,"time",f),this.setDymoFeature(e,"duration",
k),a[b].label&&!isNaN(a[b].label)&&this.setDymoFeature(e,"segmentLabel",a[b].label.value),g=e,e=c.getFeature("time"),f=g.getFeature("time"),(isNaN(e)||Array.isArray(e)||f<e)&&n.setDymoFeature(c,"time",f),r=c.getFeature("duration"),g=g.getFeature("duration"),(isNaN(r)||Array.isArray(r)||e+r<f+g)&&n.setDymoFeature(c,"duration",f+g-e))}d();x++};this.setDymoFeature=function(a,h,b){if("string"===typeof h||h instanceof String)h=k(h);a.setFeature(h.name,b);y[a.getUri()][h.name]=a.getFeatureJson(h.name);
g(a,h)};this.resetDymo()};function DymoTemplates(){}DymoTemplates.createAnnotatedBarAndBeatDymo=function(a,c,b){for(var e=[c[0],c[0]],d=["1",""],g=1;g<c.length;g++)e[g+1]=c[g],d[g+1]="";DymoTemplates.loadMultipleFeatures(a,e,d,0,b)};
DymoTemplates.createGratefulDeadDymo=function(a,c,b){DymoTemplates.loadMultipleFeatures(a,"features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_segmentino_segmentino_segmentation.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_crest_crest.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_loudness_loudness.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_spectral_centroid_spectral_centroid.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_spectral_standard_deviation_spectral_standard_deviation.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_qm-vamp-plugins_qm-chromagram_chromagram.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_qm-vamp-plugins_qm-mfcc_coefficients.n3".split(" ")," 1      ".split(" "),
0,function(){Similarity.addSimilaritiesTo(a.dymo);a.similarityGraph=a.dymo.toJsonSimilarityGraph();console.log(a.similarityGraph);c.$apply()})};
DymoTemplates.createGratefulDeadDymos=function(a,c,b){b.get("getallfiles/",{params:{directory:"app/features/gd_test/"}}).success(function(c){function d(m){m<c.length?(console.log(c[m]),b.get("getallfiles/",{params:{directory:"app/features/gd_test/"+c[m]+"/"}}).success(function(a){a=a.filter(function(a){return 0>a.indexOf(".DS_Store")});for(var b=0;b<a.length;b++)g.push("app/features/gd_test/"+c[m]+"/"+a[b]+"/");d(m+1)})):(console.log(g),DymoTemplates.loadAndSaveMultipleDeadDymos(a,g,0,b))}c=c.filter(function(a){return 0>
a.indexOf(".")});var g=[];d(0)})};
DymoTemplates.loadAndSaveMultipleDeadDymos=function(a,c,b,e){b<c.length&&e.get("getallfiles/",{params:{directory:c[b]}}).success(function(d){var g=c[b].substring(c[b].indexOf("/"));d=getUris(g,d,"segmentation.n3 crest.n3 loudness.n3 spectral_centroid.n3 standard_deviation.n3 chromagram.n3 mfcc_coefficients.n3".split(" ")," 1       ".split(" "));DymoTemplates.loadMultipleFeatures(a,d[0],d[1],0,function(){Similarity.addSimilaritiesTo(a.dymo);a.similarityGraph=a.dymo.toJsonSimilarityGraph();var d=g.substring(0,
g.length-1),d=d.substring(d.lastIndexOf("/")+1)+".dymo.json";(new DymoWriter(e)).writeDymoToJson(a.dymo.toJsonHierarchy(),"features/gd_equal_similarity2/",d);a.resetDymo();DymoTemplates.loadAndSaveMultipleDeadDymos(a,c,b+1,e)})})};function getUris(a,c,b,e){for(var d=[],g=[],m=0,p=b.length;m<p;m++){var k=c.filter(function(a){return 0<a.indexOf(b[m])})[0];k&&(d.push(a+k),g.push(e[m]))}return[d,g]}
DymoTemplates.loadMultipleFeatures=function(a,c,b,e,d){var g=new FeatureLoader;e<c.length&&c[e]?g.loadFeature(c[e],b[e],a,function(){DymoTemplates.loadMultipleFeatures(a,c,b,e+1,d)}):e<c.length-1?DymoTemplates.loadMultipleFeatures(a,c,b,e+1,d):d&&d()};
DymoTemplates.createSebastianDymo=function(a,c,b){var e=a.getFeature("onset"),d=a.getFeature("pitch"),g=a.addDymo();a.setDymoFeature(g,e,0);a.setDymoFeature(g,d,0);b.get("getsourcefilesindir/",{params:{directory:"audio/Chopin_Op028-04_003_20100611-SMD/"}}).success(function(m){m=m.filter(function(a){return 4<a.split("_").length-1});for(var p=0;p<m.length;p++){$scope.scheduler.addSourceFile("audio/Chopin_Op028-04_003_20100611-SMD/"+m[p]);var k=m[p].split("_"),f=k[k.length-1],f=Number.parseInt(f.substring(1,
f.indexOf(".")))/1E3,k=Number.parseInt(k[k.length-3].substring(1)),n=a.addDymo(g,"audio/Chopin_Op028-04_003_20100611-SMD/"+m[p]);a.setDymoFeature(n,e,f);a.setDymoFeature(n,d,k)}g.updatePartOrder(e.name);(new DymoLoader(c)).loadGraphFromJson("bower_components/dymo-core/example/similarity.json",a.idToDymo,function(){a.updateGraphAndMap()},b)})};
DymoTemplates.createSebastianDymo2=function(a){var c=a.getFeature("onset"),b=a.getFeature("pitch"),e=a.addDymo();a.setDymoFeature(e,c,0);a.setDymoFeature(e,b,0);$http.get("getsourcefilesindir/",{params:{directory:"audio/scale_out/scale_single/"}}).success(function(d){d=d.filter(function(a){return 4<a.split("_").length-1});for(var g=0;g<d.length;g++){$scope.scheduler.addSourceFile("audio/scale_out/scale_single/"+d[g]);var m=d[g].split("_"),p=Number.parseInt(m[4].substring(1))/1E3,m=Number.parseInt(m[2].substring(1)),
k=a.addDymo(e,"audio/scale_out/scale_single/"+d[g]);a.setDymoFeature(k,c,p);a.setDymoFeature(k,b,m)}e.updatePartOrder(c.name)})};
DymoTemplates.createSebastianDymo3=function(a,c){var b=a.addDymo();a.setDymoFeature(b,ONSET_FEATURE,0);a.setDymoFeature(b,PITCH_FEATURE,0);a.setDymoFeature(b,DURATION_FEATURE,0);a.setDymoFeature(b,"velocity",0);a.setDymoFeature(b,"onsetS",0);a.setDymoFeature(b,"durationS",0);c.get("getsourcefilesindir/",{params:{directory:"audio/Chopin_Op028-11_003_20100611-SMD-cut/"}}).success(function(c){c=c.filter(function(a){return 4<a.split("_").length-1});for(var d=0;d<c.length;d++){a.getScheduler().addSourceFile("audio/Chopin_Op028-11_003_20100611-SMD-cut/"+
c[d]);var g=c[d].split("_"),m=Number.parseInt(g[4].substring(1)),p=Number.parseInt(g[6].substring(2))/1E3,k=Number.parseInt(g[7].substring(2))/1E3,f=Number.parseInt(g[8].substring(2)),n=Number.parseInt(g[9].substring(2))/1E3,g=Number.parseInt(g[10].substring(2))/1E3,l=a.addDymo(b,"audio/Chopin_Op028-11_003_20100611-SMD-cut/"+c[d]);a.setDymoFeature(l,PITCH_FEATURE,m);a.setDymoFeature(l,ONSET_FEATURE,p);a.setDymoFeature(l,DURATION_FEATURE,k);a.setDymoFeature(l,"velocity",f);a.setDymoFeature(l,"onsetS",
n);a.setDymoFeature(l,"durationS",g);l.getParameter(ONSET).update(p)}b.updatePartOrder(ONSET_FEATURE)})};
DymoTemplates.createAchBachDymo=function(a){var c=a.getFeature(ONSET_FEATURE),b=a.getFeature(PITCH_FEATURE),e=a.getFeature(DURATION_FEATURE),d=a.getFeature("onsetS"),g=a.getFeature("durationS"),m=a.getFeature("time"),p=a.addDymo();a.setDymoFeature(p,c,0);a.setDymoFeature(p,b,0);a.setDymoFeature(p,e,0);$http.get("audio/achachbach10/01-AchGottundHerr.txt").success(function(k){k=k.split("\n");for(var f=0;f<k.length;f++)k[f]=k[f].split("\t");k.sort(function(a,h){return a[0]-h[0]});for(var n=[],f=0;f<
k.length;f++){var l=k[f][0],q=k[f][1],u=Number.parseInt(k[f][3]);if(n[u]){var t=n[u][0],v=q-n[u][2];k[t][4]=l-n[u][1];k[t][5]=v}n[u]=[f,l,q]}for(f=k.length-4;f<k.length;f++)k[f][4]=2700,k[f][5]=2700;for(f=0;f<k.length;f++)if(6==k[f].length){var n=k[f],l=Number.parseInt(n[2]),q=Number.parseInt(n[0])/1E3,u=Number.parseInt(n[1])/1E3,t=Number.parseInt(n[4])/1E3,v=Number.parseInt(n[5])/1E3,h;1==n[3]?h=a.addDymo(p,"audio/achachbach10/01-AchGottundHerr-violin.wav"):2==n[3]?h=a.addDymo(p,"audio/achachbach10/01-AchGottundHerr-clarinet.wav"):
3==n[3]?h=a.addDymo(p,"audio/achachbach10/01-AchGottundHerr-saxphone.wav"):4==n[3]&&(h=a.addDymo(p,"audio/achachbach10/01-AchGottundHerr-bassoon.wav"));a.setDymoFeature(h,b,l);a.setDymoFeature(h,m,q);a.setDymoFeature(h,c,q);a.setDymoFeature(h,e,t);a.setDymoFeature(h,d,u);a.setDymoFeature(h,g,v);h.getParameter(ONSET).update(q)}p.updatePartOrder(c.name)});$http.get("getsourcefilesindir/",{params:{directory:"audio/achachbach10/"}}).success(function(a){a=a.filter(function(a){return 0<=a.indexOf("wav")});
for(var b=0;b<a.length;b++)$scope.scheduler.addSourceFile("audio/achachbach10/"+a[b])})};function createRandomTriangle(){return[{0:Math.random(),1:Math.random()},{0:Math.random(),1:Math.random()},{0:Math.random(),1:Math.random()}]};function FeatureLoader(){function a(a,d,f,g){t(a,function(k){c(k,function(c){b(c,function(b){0<b.length?(p(a,d,f,b),g&&g()):e(c,function(b){var c=b.name;c||(c=a.split("_"),c=c[c.length-1].split(".")[0]);f.addFeature(c,b.values);g&&g()})})})})}function c(a,b){var c=N3.Store();N3.Parser().parse(a,function(a,h,d){h?c.addTriple(h):b(c)})}function b(a,b){for(var c=[],e=a.find(null,"http://purl.org/NET/c4dm/event.owl#time",null),f=0,k=e.length;f<k;f++){var l=d(a,e[f].object,"http://purl.org/NET/c4dm/timeline.owl#at");
l||(l=d(a,e[f].object,"http://purl.org/NET/c4dm/timeline.owl#beginsAt"));var n=d(a,e[f].object,"http://purl.org/NET/c4dm/timeline.owl#duration"),l={time:{value:m(l)},label:{value:g(d(a,e[f].subject,"http://www.w3.org/2000/01/rdf-schema#label"))}};n&&(l.duration={value:m(n)});c.push(l)}b(c)}function e(a,b){for(var c=g(d(a,null,"http://purl.org/dc/elements/1.1/title")),e=g(d(a,null,"http://purl.org/ontology/af/value")),e=e.split(" ").map(function(a){return parseFloat(a)}),f=g(d(a,null,"http://purl.org/ontology/af/dimensions")),
f=f.split(" ").map(function(a){return Number.parseInt(a)}),k=d(a,null,"http://purl.org/ontology/vamp/computed_by"),l=m(d(a,k,"http://purl.org/ontology/vamp/step_size")),k=m(d(a,k,"http://purl.org/ontology/vamp/sample_rate")),n=[],p=0;p<e.length;){for(var t=[],q=0;q<f[0];q++)t[q]=e[p+q];n.push({time:{value:p*l/k},value:t});p+=f[0]}b({name:c,values:n})}function d(a,b,c){a=a.find(b,c,null);if(0<a.length)return a[0].object}function g(a){if(a)return N3.Util.getLiteralValue(a)}function m(a){a=N3.Util.getLiteralValue(a);
"P"==a.charAt(0)&&(a=a.substring(2,a.length-1));return Number(a)}function p(a,b,c,d){v[a]=d.sort(function(a,b){return a.time.value-b.time.value});d=v[a];b&&v[a][0].label&&(d=d.filter(function(a){return a.label.value==b}));c.addSegmentation(d)}function k(a,b,c,d){t(a,function(a){f(JSON.parse(a),b,c,d)})}function f(a,b,c,d){"file_metadata"==Object.keys(a)[0]?n(a,b,c,d):l(a,b,c,d)}function n(a,b,c,d){a=a[Object.keys(a)[1]][0];var e=a.annotation_metadata.annotator.output_id;"beats"==e||"onsets"==e?(a=
a.data,b&&a[0].label&&(a=a.filter(function(a){return a.label.value==b})),c.addSegmentation(a)):c.addFeature(e,a.data);d&&d()}function l(a,b,c,d){var e=a["@type"];"afv:BarandBeatTracker"==e||"afv:Onsets"==e?(a=a["afo:values"],b&&a[0]["afo:value"]&&(a=a.filter(function(a){return a["afo:value"]==b})),a=q(a),c.addSegmentation(a)):(a=u(a["afo:values"]),c.addFeature(e,a));d&&d()}function q(a){for(var b=[],c=0;c<a.length;c++)b.push({time:{value:a[c]["tl:at"]},label:{value:a[c]["afo:value"]}});return b}function u(a){for(var b=
[],c=0;c<a.length;c++)b.push({time:{value:a[c]["tl:at"]},value:[a[c]["afo:value"]]});return b}function t(a,b){var c=new XMLHttpRequest;c.addEventListener("load",function(){console.log("loaded "+a);b(this.responseText)});c.addEventListener("error",function(){console.log("loading "+a+" failed");b(this.responseText)});c.open("GET",a);c.send()}var v={};this.loadFeature=function(b,c,d,e){if(b.constructor==Object)f(b,c,d,e);else{var g=b.split("."),g=g[g.length-1];"n3"==g?a(b,c,d,e):"json"==g&&k(b,c,d,e)}}}
;var MEAN="mean",MEDIAN="median",FIRST="first";function Similarity(){}Similarity.addSimilaritiesTo=function(a){var c=a.getDymoMap();for(a=[a];0<a.length;){if(1<a.length){var b=Similarity.toVectors(a),b=Similarity.getCosineSimilarities(b);Similarity.addHighestSimilarities(c,b,a.length)}a=Similarity.getAllParts(a)}};Similarity.addSimilaritesAbove=function(a,c,b){for(var e in c)for(var d in c[e])c[e][d]>b&&(a[e].addSimilar(a[d]),a[d].addSimilar(a[e]))};
Similarity.addHighestSimilarities=function(a,c,b){var e=[],d;for(d in c)for(var g in c[d])e.push([c[d][g],d,g]);e=e.sort(function(a,b){return b[0]-a[0]});c=0;for(b=Math.min(e.length,b);c<b;c++)d=e[c],a[d[1]].addSimilar(a[d[2]]),a[d[2]].addSimilar(a[d[1]])};Similarity.getAllParts=function(a){for(var c=[],b=0,e=a.length;b<e;b++)Array.prototype.push.apply(c,a[b].getParts());return c};
Similarity.toVectors=function(a,c){for(var b={},e=[],d=0,g=a.length;d<g;d++){for(var m=[],p=a[d].getFeatures(),k=Object.keys(p),f=0,n=k.length;f<n;f++){var l=p[k[f]];c&&1<l.length&&(l=Similarity.reduce(l));e[f]=e[f]?Math.max(l,e[f]):l;1<l.length?Array.prototype.push.apply(m,l):m.push(l)}b[a[d].getUri()]=m}d=0;for(g=a.length;d<g;d++)for(m=b[a[d].getUri()],f=0,n=m.length;f<n;f++)e[f]&&(m[f]/=e[f]);return b};
Similarity.reduce=function(a){var c=Array.apply(null,Array(a.length)).map(Number.prototype.valueOf,1);return Similarity.getCosineSimilarity(a,c)};Similarity.getCosineSimilarities=function(a){var c={},b;for(b in a)for(var e in a)b<e&&(c[b]||(c[b]={}),c[b][e]=Similarity.getCosineSimilarity(a[b],a[e]));return c};Similarity.getCosineSimilarity=function(a,c){return math.dot(a,c)/math.norm(a)/math.norm(c)};
