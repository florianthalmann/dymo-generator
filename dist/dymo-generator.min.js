function DymoGenerator(a,d){function e(a,n){var b=k.addDymo(a),c=n.getFeatures(),d;for(d in c)k.setDymoFeature(b,h(d),c[d]);k.setDymoFeature(b,h("level"),n.getLevel());c=n.getParts();for(d=0;d<c.length;d++)e(b,c[d])}function b(a){r=a.toJsonHierarchyGraph();u=a.toJsonSimilarityGraph();if(a){var b=a.toFlatJson();p[a.getUri()]=a;n[a.getUri()]=b;for(b=0;b<v.length;b++)c(a,v[b])}}function c(a,n){var b=a.getFeature(n.name);if(!isNaN(b))f(n,b);else if(b instanceof Array)for(var c=0;c<b.length;c++)f(n,b[c])}
function f(a,b){void 0==a.max?(a.min=b,a.max=b):(a.min=Math.min(b,a.min),a.max=Math.max(b,a.max))}function g(a){var b=[];if(0<a.length){for(var n=a[0].value.length,c=0;c<n;c++)if(w==FIRST)b[c]=a[0].value[c];else if(w==MEAN)b[c]=a.reduce(function(a,b){return a+b.value[c]},0)/a.length;else if(w==MEDIAN){a.sort(function(a,b){return a.value[c]-b.value[c]});var d=Math.floor(values.length/2);b[c]=a[d].value[c];0==a.length%2&&(b[c]+=a[d-1].value[c])}return 1==b.length?b[0]:b}return 0}function h(a){for(var b=
0;b<v.length;b++)if(v[b].name==a)return v[b];a=l(a);v.splice(v.length-2,0,a);d(a);return a}function l(a,b,c){return void 0!=b&&void 0!=c?{name:a,min:b,max:c}:{name:a,min:1E3,max:0}}var k=this,q,m,t,r,u,p,n,v,x,w=MEAN,y;this.resetDymo=function(){m=q=void 0;t=!1;r={nodes:[],links:[]};u={nodes:[],links:[]};p={};n={};v=[l("level"),l("random",0,1)];x=0};this.setDymo=function(a,b){this.resetDymo();e(void 0,a)};this.getDymo=function(){return q};this.getDymoGraph=function(){return r};this.getSimilarityGraph=
function(){return u};this.getFeatures=function(){return v};this.setCondensationMode=function(a){w=a};this.setCurrentSourcePath=function(a){y=a};this.getScheduler=function(){return a};this.getRealDymo=function(a){return p[a["@id"]]};this.setAudioFileChanged=function(){t=!0;if(q){var c=new DynamicMusicObject("dymo"+Object.keys(p).length,a,PARALLEL);c.addPart(q);q=c;b(q)}};this.addDymo=function(c,n){c&&c.getUri();var d=new DynamicMusicObject("dymo"+Object.keys(p).length,a);q||(q=d);c&&c.addPart(d);n&&
d.setSourcePath(n);b(d);return d};this.addFeature=function(a,c,n){a=h(a);for(n=0;n<r.nodes.length;n++){var d=r.nodes[n].time.value,e=r.nodes[n].duration.value,f=c.filter(function(a){return d<=a.time.value&&a.time.value<d+e});1>f.length&&(f=c.filter(function(a){return a.time.value<d}),f=f[f.length-1]);f=g(f);this.setDymoFeature(this.getRealDymo(r.nodes[n]),a,f)}b()};this.addSegmentation=function(a){0==Object.keys(p).length?m=this.addDymo(void 0,y):t&&(m=this.addDymo(q,y),x=m.getLevel(),t=!1);for(var c=
0;c<a.length;c++){a:{for(var n=a[c].time.value,d=m,e=m.getLevel();e<x;){var f=d.getParts();if(0<f.length){for(var g=0;g<f.length;g++)if(f[g].getFeature("time")<=n)d=f[g];else if(0==g)d=f[g];else break;e++}else{parent=d;break a}}parent=d}var n=a[c].time.value,h;a[c].duration?h=a[c].duration.value:a[c+1]?h=a[c+1].time.value-n:parent.getFeature("time")&&parent.getFeature("duration")&&(h=parent.getFeature("time")+parent.getFeature("duration")-n);0<h&&(d=this.addDymo(parent),this.setDymoFeature(d,"time",
n),this.setDymoFeature(d,"duration",h),a[c].label&&!isNaN(a[c].label)&&this.setDymoFeature(d,"segmentLabel",a[c].label.value),n=parent,g=d,d=n.getFeature("time"),e=g.getFeature("time"),(isNaN(d)||Array.isArray(d)||e<d)&&k.setDymoFeature(n,"time",e),f=n.getFeature("duration"),g=g.getFeature("duration"),(isNaN(f)||Array.isArray(f)||d+f<e+g)&&k.setDymoFeature(n,"duration",e+g-d))}b();x++};this.setDymoFeature=function(a,b,d){if("string"===typeof b||b instanceof String)b=h(b);a.setFeature(b.name,d);n[a.getUri()][b.name]=
a.getFeatureJson(b.name);c(a,b)};this.resetDymo()};function DymoTemplates(){}DymoTemplates.createAnnotatedBarAndBeatDymo=function(a,d,e){for(var b=[d[0],d[0]],c=["","1"],f=1;f<d.length;f++)b[f+1]=d[f],c[f+1]="";DymoTemplates.loadMultipleFeatures(a,b,c,0,e)};
DymoTemplates.createGratefulDeadDymo=function(a,d,e){DymoTemplates.loadMultipleFeatures(a,"features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_segmentino_segmentino_segmentation.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_crest_crest.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_loudness_loudness.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_spectral_centroid_spectral_centroid.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_spectral_standard_deviation_spectral_standard_deviation.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_qm-vamp-plugins_qm-chromagram_chromagram.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_qm-vamp-plugins_qm-mfcc_coefficients.n3".split(" ")," 1      ".split(" "),
0,function(){Similarity.addSimilaritiesTo(a.dymo);a.similarityGraph=a.dymo.toJsonSimilarityGraph();console.log(a.similarityGraph);d.$apply()})};
DymoTemplates.createGratefulDeadDymos=function(a,d,e){e.get("getallfiles/",{params:{directory:"app/features/gd_test/"}}).success(function(b){function c(g){g<b.length?(console.log(b[g]),e.get("getallfiles/",{params:{directory:"app/features/gd_test/"+b[g]+"/"}}).success(function(a){a=a.filter(function(a){return 0>a.indexOf(".DS_Store")});for(var e=0;e<a.length;e++)d.push("app/features/gd_test/"+b[g]+"/"+a[e]+"/");c(g+1)})):(console.log(d),DymoTemplates.loadAndSaveMultipleDeadDymos(a,d,0,e))}b=b.filter(function(a){return 0>
a.indexOf(".")});var d=[];c(0)})};
DymoTemplates.loadAndSaveMultipleDeadDymos=function(a,d,e,b){e<d.length&&b.get("getallfiles/",{params:{directory:d[e]}}).success(function(c){var f=d[e].substring(d[e].indexOf("/"));c=getUris(f,c,"segmentation.n3 crest.n3 loudness.n3 spectral_centroid.n3 standard_deviation.n3 chromagram.n3 mfcc_coefficients.n3".split(" ")," 1       ".split(" "));DymoTemplates.loadMultipleFeatures(a,c[0],c[1],0,function(){Similarity.addSimilaritiesTo(a.dymo);a.similarityGraph=a.dymo.toJsonSimilarityGraph();var c=f.substring(0,
f.length-1),c=c.substring(c.lastIndexOf("/")+1)+".dymo.json";(new DymoWriter(b)).writeDymoToJson(a.dymo.toJsonHierarchy(),"features/gd_equal_similarity2/",c);a.resetDymo();DymoTemplates.loadAndSaveMultipleDeadDymos(a,d,e+1,b)})})};function getUris(a,d,e,b){for(var c=[],f=[],g=0,h=e.length;g<h;g++){var l=d.filter(function(a){return 0<a.indexOf(e[g])})[0];l&&(c.push(a+l),f.push(b[g]))}return[c,f]}
DymoTemplates.loadMultipleFeatures=function(a,d,e,b,c){var f=new FeatureLoader;b<d.length&&d[b]?f.loadFeature(d[b],e[b],a,function(){DymoTemplates.loadMultipleFeatures(a,d,e,b+1,c)}):b<d.length-1?DymoTemplates.loadMultipleFeatures(a,d,e,b+1,c):c&&c()};
DymoTemplates.createSebastianDymo=function(){var a=getFeature("onset"),d=getFeature("pitch"),e=addDymo();setDymoFeature(e,a,0);setDymoFeature(e,d,0);$http.get("getsourcefilesindir/",{params:{directory:"audio/Chopin_Op028-04_003_20100611-SMD/"}}).success(function(b){b=b.filter(function(a){return 4<a.split("_").length-1});for(var c=0;c<b.length;c++){$scope.scheduler.addSourceFile("audio/Chopin_Op028-04_003_20100611-SMD/"+b[c]);var f=b[c].split("_"),g=f[f.length-1],g=Number.parseInt(g.substring(1,g.indexOf(".")))/
1E3,f=Number.parseInt(f[f.length-3].substring(1)),h=addDymo(e,"audio/Chopin_Op028-04_003_20100611-SMD/"+b[c]);setDymoFeature(h,a,g);setDymoFeature(h,d,f)}e.updatePartOrder(a.name);(new DymoLoader(scheduler)).loadGraphFromJson("bower_components/dymo-core/example/similarity.json",idToDymo,function(){updateGraphAndMap()},$http)})};
DymoTemplates.createSebastianDymo2=function(){var a=getFeature("onset"),d=getFeature("pitch"),e=addDymo();setDymoFeature(e,a,0);setDymoFeature(e,d,0);$http.get("getsourcefilesindir/",{params:{directory:"audio/scale_out/scale_single/"}}).success(function(b){b=b.filter(function(a){return 4<a.split("_").length-1});for(var c=0;c<b.length;c++){$scope.scheduler.addSourceFile("audio/scale_out/scale_single/"+b[c]);var f=b[c].split("_"),g=Number.parseInt(f[4].substring(1))/1E3,f=Number.parseInt(f[2].substring(1)),
h=addDymo(e,"audio/scale_out/scale_single/"+b[c]);setDymoFeature(h,a,g);setDymoFeature(h,d,f)}e.updatePartOrder(a.name)})};
DymoTemplates.createSebastianDymo3=function(a,d){var e=a.addDymo();a.setDymoFeature(e,ONSET_FEATURE,0);a.setDymoFeature(e,PITCH_FEATURE,0);a.setDymoFeature(e,DURATION_FEATURE,0);a.setDymoFeature(e,"velocity",0);a.setDymoFeature(e,"onsetS",0);a.setDymoFeature(e,"durationS",0);d.get("getsourcefilesindir/",{params:{directory:"audio/Chopin_Op028-11_003_20100611-SMD-cut/"}}).success(function(b){b=b.filter(function(a){return 4<a.split("_").length-1});for(var c=0;c<b.length;c++){a.getScheduler().addSourceFile("audio/Chopin_Op028-11_003_20100611-SMD-cut/"+
b[c]);var d=b[c].split("_"),g=Number.parseInt(d[4].substring(1)),h=Number.parseInt(d[6].substring(2))/1E3,l=Number.parseInt(d[7].substring(2))/1E3,k=Number.parseInt(d[8].substring(2)),q=Number.parseInt(d[9].substring(2))/1E3,d=Number.parseInt(d[10].substring(2))/1E3,m=a.addDymo(e,"audio/Chopin_Op028-11_003_20100611-SMD-cut/"+b[c]);a.setDymoFeature(m,PITCH_FEATURE,g);a.setDymoFeature(m,ONSET_FEATURE,h);a.setDymoFeature(m,DURATION_FEATURE,l);a.setDymoFeature(m,"velocity",k);a.setDymoFeature(m,"onsetS",
q);a.setDymoFeature(m,"durationS",d);m.getParameter(ONSET).update(h)}e.updatePartOrder(ONSET_FEATURE)})};
DymoTemplates.createAchBachDymo=function(){var a=getFeature(ONSET_FEATURE),d=getFeature(PITCH_FEATURE),e=getFeature(DURATION_FEATURE),b=getFeature("onsetS"),c=getFeature("durationS"),f=getFeature("time"),g=addDymo();setDymoFeature(g,a,0);setDymoFeature(g,d,0);setDymoFeature(g,e,0);$http.get("audio/achachbach10/01-AchGottundHerr.txt").success(function(h){h=h.split("\n");for(var l=0;l<h.length;l++)h[l]=h[l].split("\t");h.sort(function(a,c){return a[0]-c[0]});for(var k=[],l=0;l<h.length;l++){var q=h[l][0],
m=h[l][1],t=Number.parseInt(h[l][3]);if(k[t]){var r=k[t][0],u=m-k[t][2];h[r][4]=q-k[t][1];h[r][5]=u}k[t]=[l,q,m]}for(l=h.length-4;l<h.length;l++)h[l][4]=2700,h[l][5]=2700;for(l=0;l<h.length;l++)if(6==h[l].length){var k=h[l],q=Number.parseInt(k[2]),m=Number.parseInt(k[0])/1E3,t=Number.parseInt(k[1])/1E3,r=Number.parseInt(k[4])/1E3,u=Number.parseInt(k[5])/1E3,p;1==k[3]?p=addDymo(g,"audio/achachbach10/01-AchGottundHerr-violin.wav"):2==k[3]?p=addDymo(g,"audio/achachbach10/01-AchGottundHerr-clarinet.wav"):
3==k[3]?p=addDymo(g,"audio/achachbach10/01-AchGottundHerr-saxphone.wav"):4==k[3]&&(p=addDymo(g,"audio/achachbach10/01-AchGottundHerr-bassoon.wav"));setDymoFeature(p,d,q);setDymoFeature(p,f,m);setDymoFeature(p,a,m);setDymoFeature(p,e,r);setDymoFeature(p,b,t);setDymoFeature(p,c,u);p.getParameter(ONSET).update(m)}g.updatePartOrder(a.name)});$http.get("getsourcefilesindir/",{params:{directory:"audio/achachbach10/"}}).success(function(a){a=a.filter(function(a){return 0<=a.indexOf("wav")});for(var c=0;c<
a.length;c++)$scope.scheduler.addSourceFile("audio/achachbach10/"+a[c])})};
DymoTemplates.createAreasDemo=function(a,d){a.addDymo();if(0<d.length){var e=new BrownianControls,b=new BrownianControls;e.frequency.update(500);b.frequency.update(500);e.maxStepSize.update(.1);b.maxStepSize.update(.1);for(var c=0;c<d.length;c++){var f=d[c],g=PolygonTools.getPolygonFunctionString(f),h=a.dymo.getParts()[c];a.dymo.addMapping(new Mapping([e.brownianControl,b.brownianControl],!1,g,[h],PLAY));g=PolygonTools.getInterpolatedPolygonFunctionString(f);a.dymo.addMapping(new Mapping([e.brownianControl,
b.brownianControl],!1,g,[h],AMPLITUDE));h.getParameter(LOOP).update(1)}}else this.createRandomAreasDemo(a)};
DymoTemplates.createRandomAreasDemo=function(a){var d=new BrownianControls,e=new BrownianControls;d.maxStepSize.update(.03);e.maxStepSize.update(.03);for(var b=0;b<a.dymo.getParts().length;b++){var c=createRandomTriangle(),f=PolygonTools.getPolygonFunctionString(c),g=a.dymo.getParts()[b];a.dymo.addMapping(new Mapping([d.brownianControl,e.brownianControl],!1,f,[g],PLAY));f=PolygonTools.getInterpolatedPolygonFunctionString(c);a.dymo.addMapping(new Mapping([d.brownianControl,e.brownianControl],!1,f,
[g],AMPLITUDE));g.getParameter(LOOP).update(1)}};function createRandomTriangle(){return[{0:Math.random(),1:Math.random()},{0:Math.random(),1:Math.random()},{0:Math.random(),1:Math.random()}]};function FeatureLoader(){function a(a,c,f,g){u(a,function(k){d(k,function(d){e(d,function(e){0<e.length?(h(a,c,f,e),g()):b(d,function(c){var b=c.name;b||(b=a.split("_"),b=b[b.length-1].split(".")[0]);f.addFeature(b,c.values);g()})})})})}function d(a,c){var b=N3.Store();N3.Parser().parse(a,function(a,d,n){d?b.addTriple(d):c(b)})}function e(a,b){for(var d=[],e=a.find(null,"http://purl.org/NET/c4dm/event.owl#time",null),h=0,k=e.length;h<k;h++){var l=c(a,e[h].object,"http://purl.org/NET/c4dm/timeline.owl#at");
l||(l=c(a,e[h].object,"http://purl.org/NET/c4dm/timeline.owl#beginsAt"));var m=c(a,e[h].object,"http://purl.org/NET/c4dm/timeline.owl#duration"),l={time:{value:g(l)},label:{value:f(c(a,e[h].subject,"http://www.w3.org/2000/01/rdf-schema#label"))}};m&&(l.duration={value:g(m)});d.push(l)}b(d)}function b(a,b){for(var d=f(c(a,null,"http://purl.org/dc/elements/1.1/title")),e=f(c(a,null,"http://purl.org/ontology/af/value")),e=e.split(" ").map(function(a){return parseFloat(a)}),h=f(c(a,null,"http://purl.org/ontology/af/dimensions")),
h=h.split(" ").map(function(a){return Number.parseInt(a)}),k=c(a,null,"http://purl.org/ontology/vamp/computed_by"),l=g(c(a,k,"http://purl.org/ontology/vamp/step_size")),k=g(c(a,k,"http://purl.org/ontology/vamp/sample_rate")),m=[],p=0;p<e.length;){for(var q=[],r=0;r<h[0];r++)q[r]=e[p+r];m.push({time:{value:p*l/k},value:q});p+=h[0]}b({name:d,values:m})}function c(a,b,c){a=a.find(b,c,null);if(0<a.length)return a[0].object}function f(a){if(a)return N3.Util.getLiteralValue(a)}function g(a){a=N3.Util.getLiteralValue(a);
"P"==a.charAt(0)&&(a=a.substring(2,a.length-1));return Number(a)}function h(a,b,c,d){p[a]=d.sort(function(a,b){return a.time.value-b.time.value});d=p[a];b&&p[a][0].label&&(d=d.filter(function(a){return a.label.value==b}));c.addSegmentation(d)}function l(a,b,c,d){u(a,function(a){k(JSON.parse(a),b,c,d)})}function k(a,b,c,d){"file_metadata"==Object.keys(a)[0]?q(a,b,c,d):m(a,b,c,d)}function q(a,b,c,d){a=a[Object.keys(a)[1]][0];var e=a.annotation_metadata.annotator.output_id;"beats"==e||"onsets"==e?(a=
a.data,b&&a[0].label&&(a=a.filter(function(a){return a.label.value==b})),c.addSegmentation(a)):c.addFeature(e,a.data);d()}function m(a,b,c,d){var e=a["@type"];"afv:BarandBeatTracker"==e||"afv:Onsets"==e?(a=a["afo:values"],b&&a[0]["afo:value"]&&(a=a.filter(function(a){return a["afo:value"]==b})),a=t(a),c.addSegmentation(a)):(a=r(a["afo:values"]),c.addFeature(e,a));d()}function t(a){for(var b=[],c=0;c<a.length;c++)b.push({time:{value:a[c]["tl:at"]},label:{value:a[c]["afo:value"]}});return b}function r(a){for(var b=
[],c=0;c<a.length;c++)b.push({time:{value:a[c]["tl:at"]},value:[a[c]["afo:value"]]});return b}function u(a,c){var b=new XMLHttpRequest;b.addEventListener("load",function(){console.log("loaded "+a);c(this.responseText)});b.addEventListener("error",function(){console.log("loading "+a+" failed");c(this.responseText)});b.open("GET",a);b.send()}var p={};this.loadFeature=function(b,c,d,e){if(b.constructor==Object)k(b,c,d,e);else{var f=b.split("."),f=f[f.length-1];"n3"==f?a(b,c,d,e):"json"==f&&l(b,c,d,e)}}}
;var MEAN="mean",MEDIAN="median",FIRST="first";function Similarity(){}Similarity.addSimilaritiesTo=function(a){var d=a.getDymoMap();for(a=[a];0<a.length;){if(1<a.length){var e=Similarity.toVectors(a),e=Similarity.getCosineSimilarities(e);Similarity.addHighestSimilarities(d,e,a.length)}a=Similarity.getAllParts(a)}};Similarity.addSimilaritesAbove=function(a,d,e){for(var b in d)for(var c in d[b])d[b][c]>e&&(a[b].addSimilar(a[c]),a[c].addSimilar(a[b]))};
Similarity.addHighestSimilarities=function(a,d,e){var b=[],c;for(c in d)for(var f in d[c])b.push([d[c][f],c,f]);b=b.sort(function(a,b){return b[0]-a[0]});d=0;for(e=Math.min(b.length,e);d<e;d++)c=b[d],a[c[1]].addSimilar(a[c[2]]),a[c[2]].addSimilar(a[c[1]])};Similarity.getAllParts=function(a){for(var d=[],e=0,b=a.length;e<b;e++)Array.prototype.push.apply(d,a[e].getParts());return d};
Similarity.toVectors=function(a,d){for(var e={},b=[],c=0,f=a.length;c<f;c++){for(var g=[],h=a[c].getFeatures(),l=Object.keys(h),k=0,q=l.length;k<q;k++){var m=h[l[k]];d&&1<m.length&&(m=Similarity.reduce(m));b[k]=b[k]?Math.max(m,b[k]):m;1<m.length?Array.prototype.push.apply(g,m):g.push(m)}e[a[c].getUri()]=g}c=0;for(f=a.length;c<f;c++)for(g=e[a[c].getUri()],k=0,q=g.length;k<q;k++)b[k]&&(g[k]/=b[k]);return e};
Similarity.reduce=function(a){var d=Array.apply(null,Array(a.length)).map(Number.prototype.valueOf,1);return Similarity.getCosineSimilarity(a,d)};Similarity.getCosineSimilarities=function(a){var d={},e;for(e in a)for(var b in a)e<b&&(d[e]||(d[e]={}),d[e][b]=Similarity.getCosineSimilarity(a[e],a[b]));return d};Similarity.getCosineSimilarity=function(a,d){return math.dot(a,d)/math.norm(a)/math.norm(d)};
