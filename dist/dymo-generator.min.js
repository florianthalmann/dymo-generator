function DymoGenerator(a,b,d){function e(a,f){a=c(a);var b=f.getFeatures(),d;for(d in b)t.setDymoFeature(a,d,b[d]);t.setDymoFeature(a,LEVEL_FEATURE,f.getLevel());f=f.getParts();for(d=0;d<f.length;d++)e(a,f[d])}function c(f,c){var b=g();a.addDymo(b,f,null,c);f||(q=b);return b}function g(){var a=CONTEXT_URI+"dymo"+y;y++;return a}function k(a){var f=[];if(a&&0<a.length){for(var c=0;c<a.length;c++)a[c].value.constructor!==Array&&(a[c].value=[a[c].value]);for(var c=a[0].value.length,b=0;b<c;b++)if("string"==
typeof a[0].value[b])f[b]=a[0].value[b];else if(x==SUMMARY.FIRST)f[b]=a[0].value[b];else if(x==SUMMARY.MEAN)f[b]=a.reduce(function(a,f){return a+f.value[b]},0)/a.length;else if(x==SUMMARY.MEDIAN){a.sort(function(a,f){return a.value[b]-f.value[b]});var e=Math.floor(a.length/2);f[b]=a[e].value[b];0==a.length%2&&(f[b]+=a[e-1].value[b])}return 1==f.length?f[0]:f}return 0}function n(){0==y?q=c(void 0,z):f&&(q=c(u,z),f=!1)}function h(f,b){for(var c=q,e=a.getLevel(q);e<b;){var d=a.findParts(c);if(0<d.length){d=
d.map(function(f){return[a.findFeature(f,TIME_FEATURE),f]});d.sort(function(a,f){return a[0]-f[0]});for(var h=0;h<d.length;h++)if(d[h][0]<=f)c=d[h][1];else if(0==h)c=d[h][1];else break;e++}else break}return c}function l(a,f){void 0==a.max?(a.min=f,a.max=f):(a.min=Math.min(f,a.min),a.max=Math.max(f,a.max))}function m(a,f){for(var c=0;c<r.length;c++)if(r[c].name==a||r[c].uri==f)return r[c];return p(a,f)}function p(a,f,c,d){!a&&f&&(a=URI_TO_TERM[f]);a&&!f&&(f=CONTEXT_URI+a);a=void 0!=c&&void 0!=d?{name:a,
uri:f,min:c,max:d}:{name:a,uri:f,min:1E3,max:0};2>r.length?r.push(a):r.splice(r.length-2,0,a);b(a);return a}var t=this,u,q,w,f,A,v,r,x=SUMMARY.MEAN,z,y=0;this.resetDymo=function(){q=u=void 0;f=!1;A={nodes:[],links:[]};v={nodes:[],links:[]};r=[];p("level",LEVEL_FEATURE);p("random",null,0,1)};this.getStore=function(){return a};this.addRendering=function(){var f=CONTEXT_URI+"rendering0";f++;w=f;a.addRendering(w,q)};this.addMapping=function(f,c,b,d){a.addMapping(f,c,b,d)};this.addNavigator=function(f,
c,b){a.addNavigator(w,f,c,b)};this.setDymo=function(a,f){this.resetDymo();e(void 0,a)};this.getCurrentTopDymo=function(){return q};this.getDymoGraph=function(){return A};this.getSimilarityGraph=function(){return v};this.getFeatures=function(){return r};this.setSummarizingMode=function(a){x=a};this.setCurrentSourcePath=function(a){z=a};this.setAudioFileChanged=function(){f=!0;if(q){var c=g();a.addDymo(c,null,q);q=c}};this.addDymo=function(a,f){return c(a,f)};this.updateGraphs=function(){Benchmarker.startTask("toPartGraph");
a.toJsonGraph(DYMO,HAS_PART,function(f){A=f;Benchmarker.startTask("toSimilarGraph");a.toJsonGraph(DYMO,HAS_SIMILAR,function(a){v=a;d&&d()})})};this.addFeature=function(f,c,b){Benchmarker.startTask("addFeature");n();f=m(f);b=a.findAllObjectsInHierarchy(q);for(var d=0;d<b.length;d++){var e=a.findFeature(b[d],TIME_FEATURE),h=a.findFeature(b[d],DURATION_FEATURE),g=c;isNaN(e)||(g=g.filter(function(a){return e<=a.time&&(isNaN(h)||a.time<e+h)}));if(1>g.length)var v=c.filter(function(a){return a.time.value<=
e}),g=0<v.length?[v[g.length-1]]:[c[0]];Benchmarker.startTask("summarize");g=k(g);this.setDymoFeature(b[d],f.uri,g)}};this.addSegmentation=function(f){n();for(var b=a.getMaxLevel(),d=0;d<f.length;d++){var e=h(f[d].time,b),g=f[d].time,v;if(f[d].duration)v=f[d].duration;else if(f[d+1])v=f[d+1].time-g;else{var k=a.findFeature(e,TIME_FEATURE),r=a.findFeature(e,DURATION_FEATURE);k&&r&&(v=k+r-g)}if(0<v){k=c(e);this.setDymoFeature(k,TIME_FEATURE,g);this.setDymoFeature(k,DURATION_FEATURE,v);var l=k,g=a.findFeature(e,
TIME_FEATURE),k=a.findFeature(l,TIME_FEATURE);if(isNaN(g)||Array.isArray(g)||k<g)t.setDymoFeature(e,TIME_FEATURE,k),g=k;r=a.findFeature(e,DURATION_FEATURE);l=a.findFeature(l,DURATION_FEATURE);(isNaN(r)||Array.isArray(r)||g+r<k+l)&&t.setDymoFeature(e,DURATION_FEATURE,k+l-g)}}};this.setDymoFeature=function(f,c,b){a.setFeature(f,c,b);if(!isNaN(b))l(m(null,c),b);else if(b instanceof Array)for(f=0;f<b.length;f++)l(m(null,c),b[f])};this.resetDymo()};function DymoTemplates(){}DymoTemplates.createSingleSourceDymoFromFeatures=function(a,b,d,e,c){a.addDymo(void 0,b);DymoTemplates.loadMultipleFeatures(a,d,e,0,function(){a.updateGraphs();c()})};
DymoTemplates.createSimilarityDymoFromFeatures=function(a,b,d,e,c){a.addDymo(void 0,b);DymoTemplates.loadMultipleFeatures(a,d,e,0,function(){Similarity.addSimilaritiesTo(a.getCurrentTopDymo(),a.getStore());a.addRendering();a.addNavigator(GRAPH_NAVIGATOR,"d","return d.getLevel() == 0");a.addNavigator(REPEATED_NAVIGATOR,"d","return d.getLevel() == 1");a.updateGraphs();c()})};
DymoTemplates.createAnnotatedBarAndBeatDymo=function(a,b,d){for(var e=[b[0],b[0]],c=["1",""],g=1;g<b.length;g++)e[g+1]=b[g],c[g+1]="";DymoTemplates.loadMultipleFeatures(a,e,c,0,d)};
DymoTemplates.createGratefulDeadDymo=function(a,b,d){DymoTemplates.loadMultipleFeatures(a,"features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_segmentino_segmentino_segmentation.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_crest_crest.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_loudness_loudness.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_spectral_centroid_spectral_centroid.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_spectral_standard_deviation_spectral_standard_deviation.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_qm-vamp-plugins_qm-chromagram_chromagram.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_qm-vamp-plugins_qm-mfcc_coefficients.n3".split(" ")," 1      ".split(" "),
0,function(){Similarity.addSimilaritiesTo(a.dymo);a.similarityGraph=a.dymo.toJsonSimilarityGraph();console.log(a.similarityGraph);b.$apply()})};
DymoTemplates.createGratefulDeadDymos=function(a,b,d){d.get("getallfiles/",{params:{directory:"app/features/gd_test/"}}).success(function(b){function c(k){k<b.length?(console.log(b[k]),d.get("getallfiles/",{params:{directory:"app/features/gd_test/"+b[k]+"/"}}).success(function(a){a=a.filter(function(a){return 0>a.indexOf(".DS_Store")});for(var d=0;d<a.length;d++)g.push("app/features/gd_test/"+b[k]+"/"+a[d]+"/");c(k+1)})):(console.log(g),DymoTemplates.loadAndSaveMultipleDeadDymos(a,g,0,d))}b=b.filter(function(a){return 0>
a.indexOf(".")});var g=[];c(0)})};
DymoTemplates.loadAndSaveMultipleDeadDymos=function(a,b,d,e){d<b.length&&e.get("getallfiles/",{params:{directory:b[d]}}).success(function(c){var g=b[d].substring(b[d].indexOf("/"));c=getUris(g,c,"segmentation.n3 crest.n3 loudness.n3 spectral_centroid.n3 standard_deviation.n3 chromagram.n3 mfcc_coefficients.n3".split(" ")," 1       ".split(" "));DymoTemplates.loadMultipleFeatures(a,c[0],c[1],0,function(){Similarity.addSimilaritiesTo(a.dymo);a.similarityGraph=a.dymo.toJsonSimilarityGraph();var c=g.substring(0,
g.length-1),c=c.substring(c.lastIndexOf("/")+1)+".dymo.json";(new DymoWriter(e)).writeDymoToJson(a.dymo.toJsonHierarchy(),"features/gd_equal_similarity2/",c);a.resetDymo();DymoTemplates.loadAndSaveMultipleDeadDymos(a,b,d+1,e)})})};function getUris(a,b,d,e){for(var c=[],g=[],k=0,n=d.length;k<n;k++){var h=b.filter(function(a){return 0<a.indexOf(d[k])})[0];h&&(c.push(a+h),g.push(e[k]))}return[c,g]}
DymoTemplates.loadMultipleFeatures=function(a,b,d,e,c){Benchmarker.startTask("loadFeatures");var g=new FeatureLoader;e<b.length&&b[e]?g.loadFeature(b[e],d[e],a,function(){DymoTemplates.loadMultipleFeatures(a,b,d,e+1,c)}):e<b.length-1?DymoTemplates.loadMultipleFeatures(a,b,d,e+1,c):c&&c()};
DymoTemplates.createSebastianDymo=function(a,b,d){var e=a.getFeature("onset"),c=a.getFeature("pitch"),g=a.addDymo();a.setDymoFeature(g,e,0);a.setDymoFeature(g,c,0);d.get("getsourcefilesindir/",{params:{directory:"audio/Chopin_Op028-04_003_20100611-SMD/"}}).success(function(k){k=k.filter(function(a){return 4<a.split("_").length-1});for(var n=0;n<k.length;n++){$scope.scheduler.addSourceFile("audio/Chopin_Op028-04_003_20100611-SMD/"+k[n]);var h=k[n].split("_"),l=h[h.length-1],l=Number.parseInt(l.substring(1,
l.indexOf(".")))/1E3,h=Number.parseInt(h[h.length-3].substring(1)),m=a.addDymo(g,"audio/Chopin_Op028-04_003_20100611-SMD/"+k[n]);a.setDymoFeature(m,e,l);a.setDymoFeature(m,c,h)}g.updatePartOrder(e.name);(new DymoLoader(b)).loadGraphFromJson("bower_components/dymo-core/example/similarity.json",a.idToDymo,function(){a.updateGraphAndMap()},d)})};
DymoTemplates.createSebastianDymo2=function(a){var b=a.getFeature("onset"),d=a.getFeature("pitch"),e=a.addDymo();a.setDymoFeature(e,b,0);a.setDymoFeature(e,d,0);$http.get("getsourcefilesindir/",{params:{directory:"audio/scale_out/scale_single/"}}).success(function(c){c=c.filter(function(a){return 4<a.split("_").length-1});for(var g=0;g<c.length;g++){$scope.scheduler.addSourceFile("audio/scale_out/scale_single/"+c[g]);var k=c[g].split("_"),n=Number.parseInt(k[4].substring(1))/1E3,k=Number.parseInt(k[2].substring(1)),
h=a.addDymo(e,"audio/scale_out/scale_single/"+c[g]);a.setDymoFeature(h,b,n);a.setDymoFeature(h,d,k)}e.updatePartOrder(b.name)})};
DymoTemplates.createSebastianDymo3=function(a,b){var d=a.addDymo();a.setDymoFeature(d,ONSET_FEATURE,0);a.setDymoFeature(d,PITCH_FEATURE,0);a.setDymoFeature(d,DURATION_FEATURE,0);a.setDymoFeature(d,"velocity",0);a.setDymoFeature(d,"onsetS",0);a.setDymoFeature(d,"durationS",0);b.get("getsourcefilesindir/",{params:{directory:"audio/Chopin_Op028-11_003_20100611-SMD-cut/"}}).success(function(b){b=b.filter(function(a){return 4<a.split("_").length-1});for(var c=0;c<b.length;c++){a.getScheduler().addSourceFile("audio/Chopin_Op028-11_003_20100611-SMD-cut/"+
b[c]);var g=b[c].split("_"),k=Number.parseInt(g[4].substring(1)),n=Number.parseInt(g[6].substring(2))/1E3,h=Number.parseInt(g[7].substring(2))/1E3,l=Number.parseInt(g[8].substring(2)),m=Number.parseInt(g[9].substring(2))/1E3,g=Number.parseInt(g[10].substring(2))/1E3,p=a.addDymo(d,"audio/Chopin_Op028-11_003_20100611-SMD-cut/"+b[c]);a.setDymoFeature(p,PITCH_FEATURE,k);a.setDymoFeature(p,ONSET_FEATURE,n);a.setDymoFeature(p,DURATION_FEATURE,h);a.setDymoFeature(p,"velocity",l);a.setDymoFeature(p,"onsetS",
m);a.setDymoFeature(p,"durationS",g);p.getParameter(ONSET).update(n)}d.updatePartOrder(ONSET_FEATURE)})};
DymoTemplates.createAchBachDymo=function(a){var b=a.getFeature(ONSET_FEATURE),d=a.getFeature(PITCH_FEATURE),e=a.getFeature(DURATION_FEATURE),c=a.getFeature("onsetS"),g=a.getFeature("durationS"),k=a.getFeature("time"),n=a.addDymo();a.setDymoFeature(n,b,0);a.setDymoFeature(n,d,0);a.setDymoFeature(n,e,0);$http.get("audio/achachbach10/01-AchGottundHerr.txt").success(function(h){h=h.split("\n");for(var l=0;l<h.length;l++)h[l]=h[l].split("\t");h.sort(function(a,f){return a[0]-f[0]});for(var m=[],l=0;l<
h.length;l++){var p=h[l][0],t=h[l][1],u=Number.parseInt(h[l][3]);if(m[u]){var q=m[u][0],w=t-m[u][2];h[q][4]=p-m[u][1];h[q][5]=w}m[u]=[l,p,t]}for(l=h.length-4;l<h.length;l++)h[l][4]=2700,h[l][5]=2700;for(l=0;l<h.length;l++)if(6==h[l].length){var m=h[l],p=Number.parseInt(m[2]),t=Number.parseInt(m[0])/1E3,u=Number.parseInt(m[1])/1E3,q=Number.parseInt(m[4])/1E3,w=Number.parseInt(m[5])/1E3,f;1==m[3]?f=a.addDymo(n,"audio/achachbach10/01-AchGottundHerr-violin.wav"):2==m[3]?f=a.addDymo(n,"audio/achachbach10/01-AchGottundHerr-clarinet.wav"):
3==m[3]?f=a.addDymo(n,"audio/achachbach10/01-AchGottundHerr-saxphone.wav"):4==m[3]&&(f=a.addDymo(n,"audio/achachbach10/01-AchGottundHerr-bassoon.wav"));a.setDymoFeature(f,d,p);a.setDymoFeature(f,k,t);a.setDymoFeature(f,b,t);a.setDymoFeature(f,e,q);a.setDymoFeature(f,c,u);a.setDymoFeature(f,g,w);f.getParameter(ONSET).update(t)}n.updatePartOrder(b.name)});$http.get("getsourcefilesindir/",{params:{directory:"audio/achachbach10/"}}).success(function(a){a=a.filter(function(a){return 0<=a.indexOf("wav")});
for(var b=0;b<a.length;b++)$scope.scheduler.addSourceFile("audio/achachbach10/"+a[b])})};function createRandomTriangle(){return[{0:Math.random(),1:Math.random()},{0:Math.random(),1:Math.random()},{0:Math.random(),1:Math.random()}]};function FeatureLoader(){function a(a,c,g,h){q(a,function(k){b(k,function(b){d(b,function(d){0<d.length?(n(a,c,g,d),h&&h()):e(b,function(b){var c=b.name;c||(c=a.split("_"),c=c[c.length-1].split(".")[0]);g.addFeature(c,b.values);h&&h()})})})})}function b(a,b){var c=N3.Store();N3.Parser().parse(a,function(a,f,d){f?c.addTriple(f):b(c)})}function d(a,b){for(var d=[],e=a.find(null,"http://purl.org/NET/c4dm/event.owl#time",null),h=0,l=e.length;h<l;h++){var m=c(a,e[h].object,"http://purl.org/NET/c4dm/timeline.owl#at");
m||(m=c(a,e[h].object,"http://purl.org/NET/c4dm/timeline.owl#beginsAt"));var n=c(a,e[h].object,"http://purl.org/NET/c4dm/timeline.owl#duration"),m={time:k(m),label:g(c(a,e[h].subject,"http://www.w3.org/2000/01/rdf-schema#label"))};n&&(m.duration=k(n));d.push(m)}b(d)}function e(a,b){var d=g(c(a,null,"http://purl.org/dc/elements/1.1/title")),e=g(c(a,null,"http://purl.org/ontology/af/value")),e=e.split(" ").map(function(a){return parseFloat(a)}),h=g(c(a,null,"http://purl.org/ontology/af/dimensions")),
h=h.split(" ").map(function(a){return Number.parseInt(a)}),l=c(a,null,"http://purl.org/ontology/vamp/computed_by"),m=k(c(a,l,"http://purl.org/ontology/vamp/step_size"));a=k(c(a,l,"http://purl.org/ontology/vamp/sample_rate"));for(var l=[],n=0;n<e.length;){for(var q=[],p=0;p<h[0];p++)q[p]=e[n+p];l.push({time:{value:n*m/a},value:q});n+=h[0]}b({name:d,values:l})}function c(a,b,c){a=a.find(b,c,null);if(0<a.length)return a[0].object}function g(a){if(a)return N3.Util.getLiteralValue(a)}function k(a){a=N3.Util.getLiteralValue(a);
"P"==a.charAt(0)&&(a=a.substring(2,a.length-1));return Number(a)}function n(a,b,c,d){w[a]=d.sort(function(a,b){return a.time.value-b.time.value});d=w[a];b&&w[a][0].label&&(d=d.filter(function(a){return a.label.value==b}));c.addSegmentation(d)}function h(a,b,c,d){q(a,function(a){l(JSON.parse(a),b,c,d)})}function l(a,b,c,d){"file_metadata"==Object.keys(a)[0]?m(a,b,c,d):p(a,b,c,d)}function m(a,b,c,d){a=a[Object.keys(a)[1]][0];var e=a.annotation_metadata.annotator.output_id;"beats"==e||"onsets"==e||"segmentation"==
e?(a=a.data,b&&a[0].value&&(a=a.filter(function(a){return a.value==b})),c.addSegmentation(a)):c.addFeature(e,a.data);d&&d()}function p(a,b,c,d){var e=a["@type"];"afv:BarandBeatTracker"==e||"afv:Onsets"==e?(a=a["afo:values"],b&&a[0]["afo:value"]&&(a=a.filter(function(a){return a["afo:value"]==b})),a=t(a),c.addSegmentation(a)):(a=u(a["afo:values"]),c.addFeature(e,a));d&&d()}function t(a){for(var b=[],c=0;c<a.length;c++)b.push({time:{value:a[c]["tl:at"]},label:{value:a[c]["afo:value"]}});return b}function u(a){for(var b=
[],c=0;c<a.length;c++)b.push({time:{value:a[c]["tl:at"]},value:[a[c]["afo:value"]]});return b}function q(a,b){var c=new XMLHttpRequest;c.addEventListener("load",function(){b(this.responseText)});c.addEventListener("error",function(){b(this.responseText)});c.open("GET",a);c.send()}var w={};this.loadFeature=function(b,c,d,e){if(b.constructor==Object)l(b,c,d,e);else{var g=b.split("."),g=g[g.length-1];"n3"==g?a(b,c,d,e):"json"==g&&h(b,c,d,e)}}};var SUMMARY={MEAN:"mean",MEDIAN:"median",FIRST:"first"};function Similarity(){}Similarity.addSimilaritiesTo=function(a,b){for(a=[a];0<a.length;){if(1<a.length){var d=Similarity.toVectors(a,b),d=Similarity.getCosineSimilarities(d);Similarity.addSimilaritiesAbove(b,d,.4)}a=Similarity.getAllParts(a,b)}};Similarity.addSimilaritiesAbove=function(a,b,d){for(var e in b)for(var c in b[e])b[e][c]>d&&(a.addSimilar(e,c),a.addSimilar(c,e))};
Similarity.addHighestSimilarities=function(a,b,d){var e=[],c;for(c in b)for(var g in b[c])e.push([b[c][g],c,g]);e=e.sort(function(a,b){return b[0]-a[0]});console.log(e.map(function(a){return a[0]}));b=0;for(d=Math.min(e.length,d);b<d;b++)c=e[b],a.addSimilar(c[1],c[2]),a.addSimilar(c[2],c[1])};Similarity.getAllParts=function(a,b){for(var d=[],e=0,c=a.length;e<c;e++)d=d.concat(b.findParts(a[e]));return d};
Similarity.toVectors=function(a,b,d){for(var e=[],c=0,g=a.length;c<g;c++){for(var k=[],n=b.findAllFeatureValues(a[c]).filter(function(a){return"string"!=typeof a}),h=0,l=n.length;h<l;h++){var m=n[h];d&&1<m.length&&(m=Similarity.reduce(m));1<m.length?k=k.concat(m):(m=Number(m),k.push(m))}e[c]=k}for(var p=[],t=[],c=0;c<e[0].length;c++){b=[];for(h=0;h<a.length;h++)isNaN(e[h][c])||b.push(e[h][c]);p[c]=math.mean(b);t[c]=math.var(b)}e=e.map(function(a){return a.map(function(a,b){return(a-p[b])/t[b]})});
h={};for(c=0;c<e.length;c++)h[a[c]]=e[c];return h};Similarity.reduce=function(a){var b=Array.apply(null,Array(a.length)).map(Number.prototype.valueOf,1);return Similarity.getCosineSimilarity(a,b)};Similarity.getCosineSimilarities=function(a){var b={},d;for(d in a)for(var e in a)d<e&&(b[d]||(b[d]={}),b[d][e]=Similarity.getCosineSimilarity(a[d],a[e]));return b};Similarity.getCosineSimilarity=function(a,b){return a.length==b.length?math.dot(a,b)/(math.norm(a)*math.norm(b)):0};
