function DymoGenerator(a,c,b){function e(a,g){a=d(a);var c=g.getFeatures(),b;for(b in c)u.setDymoFeature(a,b,c[b]);u.setDymoFeature(a,LEVEL_FEATURE,g.getLevel());g=g.getParts();for(b=0;b<g.length;b++)e(a,g[b])}function d(g,d){var b=f();a.addDymo(b,g,null,d);v||(v=b);return b}function f(){var a=CONTEXT_URI+"dymo"+A;A++;return a}function l(){a.toJsonGraph(DYMO,HAS_PART,function(g){x=g;a.toJsonGraph(DYMO,HAS_SIMILAR,function(a){r=a;b&&b()})})}function m(a){var g=[];if(0<a.length){for(var b=a[0].value.length,
d=0;d<b;d++)if(y==FIRST)g[d]=a[0].value[d];else if(y==MEAN)g[d]=a.reduce(function(a,g){return a+g.value[d]},0)/a.length;else if(y==MEDIAN){a.sort(function(a,g){return a.value[d]-g.value[d]});var c=Math.floor(a.length/2);g[d]=a[c].value[d];0==a.length%2&&(g[d]+=a[c-1].value[d])}return 1==g.length?g[0]:g}return 0}function k(g){for(var d=q,b=a.getLevel(q);b<z;){var c=a.findParts(d);if(0<c.length){c=c.map(function(g){return[a.findFeature(g,TIME_FEATURE),g]});c.sort(function(a,g){return a[0]-g[0]});for(var e=
0;e<c.length;e++)if(c[e][0]<=g)d=c[e][1];else if(0==e)d=c[e][1];else break;b++}else break}return d}function h(a,g){void 0==a.max?(a.min=g,a.max=g):(a.min=Math.min(g,a.min),a.max=Math.max(g,a.max))}function n(a){for(var g=0;g<t.length;g++)if(t[g].uri==a)return t[g];return p(null,a)}function p(a,g,d,b){!a&&g&&(a=URI_TO_TERM[g]);a&&!g&&(g=CONTEXT_URI+a);a=void 0!=d&&void 0!=b?{name:a,uri:g,min:d,max:b}:{name:a,uri:g,min:1E3,max:0};2>t.length?t.push(a):t.splice(t.length-2,0,a);c(a);return a}var u=this,
w,v,q,g,x,r,t,z,y=MEAN,B,A=0;this.resetDymo=function(){q=w=void 0;g=!1;x={nodes:[],links:[]};r={nodes:[],links:[]};t=[];p("level",LEVEL_FEATURE);p("random",null,0,1);z=0};this.setDymo=function(a,g){this.resetDymo();e(void 0,a);l()};this.getDymo=function(){return w};this.getDymoGraph=function(){return x};this.getSimilarityGraph=function(){return r};this.getFeatures=function(){return t};this.setCondensationMode=function(a){y=a};this.setCurrentSourcePath=function(a){B=a};this.setAudioFileChanged=function(){g=
!0;if(v){var d=f();a.addDymo(d,null,v);v=d;l()}};this.addDymo=function(a,g){a=d();l();return a};this.addFeature=function(g,d,b){g=p(g);b=a.findAllSubjectUris(TYPE,DYMO);for(var c=0;c<b.length;c++){var e=a.findFeature(b[c],TIME_FEATURE),h=a.findFeature(b[c],DURATION_FEATURE),f=d.filter(function(a){return e<=a.time.value&&a.time.value<e+h});1>f.length&&(f=d.filter(function(a){return a.time.value<e}),f=f[f.length-1]);f=m(f);this.setDymoFeature(b[c],g.uri,f)}l()};this.addSegmentation=function(b){0==A?
q=d(void 0,B):g&&(q=d(w,B),z=q.getLevel(),g=!1);for(var c=0;c<b.length;c++){var e=k(b[c].time.value),f=b[c].time.value,h;if(b[c].duration)h=b[c].duration.value;else if(b[c+1])h=b[c+1].time.value-f;else{var r=a.findFeature(e,TIME_FEATURE),t=a.findFeature(e,DURATION_FEATURE);r&&t&&(h=r+t-f)}if(0<h){r=d(e);this.setDymoFeature(r,TIME_FEATURE,f);this.setDymoFeature(r,DURATION_FEATURE,h);b[c].label&&!isNaN(b[c].label)&&this.setDymoFeature(r,SEGMENT_LABEL_FEATURE,b[c].label.value);var x=r,f=a.findFeature(e,
TIME_FEATURE),r=a.findFeature(x,TIME_FEATURE);(isNaN(f)||Array.isArray(f)||r<f)&&u.setDymoFeature(e,TIME_FEATURE,r);t=a.findFeature(e,DURATION_FEATURE);x=a.findFeature(x,DURATION_FEATURE);(isNaN(t)||Array.isArray(t)||f+t<r+x)&&u.setDymoFeature(e,DURATION_FEATURE,r+x-f)}}l();z++};this.setDymoFeature=function(g,d,b){a.setFeature(g,d,b);if(!isNaN(b))h(n(d),b);else if(b instanceof Array)for(g=0;g<b.length;g++)h(n(d),b[g])};this.resetDymo()};function DymoTemplates(){}DymoTemplates.createAnnotatedBarAndBeatDymo=function(a,c,b){for(var e=[c[0],c[0]],d=["1",""],f=1;f<c.length;f++)e[f+1]=c[f],d[f+1]="";DymoTemplates.loadMultipleFeatures(a,e,d,0,b)};
DymoTemplates.createGratefulDeadDymo=function(a,c,b){DymoTemplates.loadMultipleFeatures(a,"features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_segmentino_segmentino_segmentation.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_crest_crest.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_loudness_loudness.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_spectral_centroid_spectral_centroid.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_vamp-libxtract_spectral_standard_deviation_spectral_standard_deviation.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_qm-vamp-plugins_qm-chromagram_chromagram.n3 features/gd_test/Candyman/_studio/gd1981-05-02d1t05_vamp_qm-vamp-plugins_qm-mfcc_coefficients.n3".split(" ")," 1      ".split(" "),
0,function(){Similarity.addSimilaritiesTo(a.dymo);a.similarityGraph=a.dymo.toJsonSimilarityGraph();console.log(a.similarityGraph);c.$apply()})};
DymoTemplates.createGratefulDeadDymos=function(a,c,b){b.get("getallfiles/",{params:{directory:"app/features/gd_test/"}}).success(function(c){function d(l){l<c.length?(console.log(c[l]),b.get("getallfiles/",{params:{directory:"app/features/gd_test/"+c[l]+"/"}}).success(function(a){a=a.filter(function(a){return 0>a.indexOf(".DS_Store")});for(var b=0;b<a.length;b++)f.push("app/features/gd_test/"+c[l]+"/"+a[b]+"/");d(l+1)})):(console.log(f),DymoTemplates.loadAndSaveMultipleDeadDymos(a,f,0,b))}c=c.filter(function(a){return 0>
a.indexOf(".")});var f=[];d(0)})};
DymoTemplates.loadAndSaveMultipleDeadDymos=function(a,c,b,e){b<c.length&&e.get("getallfiles/",{params:{directory:c[b]}}).success(function(d){var f=c[b].substring(c[b].indexOf("/"));d=getUris(f,d,"segmentation.n3 crest.n3 loudness.n3 spectral_centroid.n3 standard_deviation.n3 chromagram.n3 mfcc_coefficients.n3".split(" ")," 1       ".split(" "));DymoTemplates.loadMultipleFeatures(a,d[0],d[1],0,function(){Similarity.addSimilaritiesTo(a.dymo);a.similarityGraph=a.dymo.toJsonSimilarityGraph();var d=f.substring(0,
f.length-1),d=d.substring(d.lastIndexOf("/")+1)+".dymo.json";(new DymoWriter(e)).writeDymoToJson(a.dymo.toJsonHierarchy(),"features/gd_equal_similarity2/",d);a.resetDymo();DymoTemplates.loadAndSaveMultipleDeadDymos(a,c,b+1,e)})})};function getUris(a,c,b,e){for(var d=[],f=[],l=0,m=b.length;l<m;l++){var k=c.filter(function(a){return 0<a.indexOf(b[l])})[0];k&&(d.push(a+k),f.push(e[l]))}return[d,f]}
DymoTemplates.loadMultipleFeatures=function(a,c,b,e,d){var f=new FeatureLoader;e<c.length&&c[e]?f.loadFeature(c[e],b[e],a,function(){DymoTemplates.loadMultipleFeatures(a,c,b,e+1,d)}):e<c.length-1?DymoTemplates.loadMultipleFeatures(a,c,b,e+1,d):d&&d()};
DymoTemplates.createSebastianDymo=function(a,c,b){var e=a.getFeature("onset"),d=a.getFeature("pitch"),f=a.addDymo();a.setDymoFeature(f,e,0);a.setDymoFeature(f,d,0);b.get("getsourcefilesindir/",{params:{directory:"audio/Chopin_Op028-04_003_20100611-SMD/"}}).success(function(l){l=l.filter(function(a){return 4<a.split("_").length-1});for(var m=0;m<l.length;m++){$scope.scheduler.addSourceFile("audio/Chopin_Op028-04_003_20100611-SMD/"+l[m]);var k=l[m].split("_"),h=k[k.length-1],h=Number.parseInt(h.substring(1,
h.indexOf(".")))/1E3,k=Number.parseInt(k[k.length-3].substring(1)),n=a.addDymo(f,"audio/Chopin_Op028-04_003_20100611-SMD/"+l[m]);a.setDymoFeature(n,e,h);a.setDymoFeature(n,d,k)}f.updatePartOrder(e.name);(new DymoLoader(c)).loadGraphFromJson("bower_components/dymo-core/example/similarity.json",a.idToDymo,function(){a.updateGraphAndMap()},b)})};
DymoTemplates.createSebastianDymo2=function(a){var c=a.getFeature("onset"),b=a.getFeature("pitch"),e=a.addDymo();a.setDymoFeature(e,c,0);a.setDymoFeature(e,b,0);$http.get("getsourcefilesindir/",{params:{directory:"audio/scale_out/scale_single/"}}).success(function(d){d=d.filter(function(a){return 4<a.split("_").length-1});for(var f=0;f<d.length;f++){$scope.scheduler.addSourceFile("audio/scale_out/scale_single/"+d[f]);var l=d[f].split("_"),m=Number.parseInt(l[4].substring(1))/1E3,l=Number.parseInt(l[2].substring(1)),
k=a.addDymo(e,"audio/scale_out/scale_single/"+d[f]);a.setDymoFeature(k,c,m);a.setDymoFeature(k,b,l)}e.updatePartOrder(c.name)})};
DymoTemplates.createSebastianDymo3=function(a,c){var b=a.addDymo();a.setDymoFeature(b,ONSET_FEATURE,0);a.setDymoFeature(b,PITCH_FEATURE,0);a.setDymoFeature(b,DURATION_FEATURE,0);a.setDymoFeature(b,"velocity",0);a.setDymoFeature(b,"onsetS",0);a.setDymoFeature(b,"durationS",0);c.get("getsourcefilesindir/",{params:{directory:"audio/Chopin_Op028-11_003_20100611-SMD-cut/"}}).success(function(c){c=c.filter(function(a){return 4<a.split("_").length-1});for(var d=0;d<c.length;d++){a.getScheduler().addSourceFile("audio/Chopin_Op028-11_003_20100611-SMD-cut/"+
c[d]);var f=c[d].split("_"),l=Number.parseInt(f[4].substring(1)),m=Number.parseInt(f[6].substring(2))/1E3,k=Number.parseInt(f[7].substring(2))/1E3,h=Number.parseInt(f[8].substring(2)),n=Number.parseInt(f[9].substring(2))/1E3,f=Number.parseInt(f[10].substring(2))/1E3,p=a.addDymo(b,"audio/Chopin_Op028-11_003_20100611-SMD-cut/"+c[d]);a.setDymoFeature(p,PITCH_FEATURE,l);a.setDymoFeature(p,ONSET_FEATURE,m);a.setDymoFeature(p,DURATION_FEATURE,k);a.setDymoFeature(p,"velocity",h);a.setDymoFeature(p,"onsetS",
n);a.setDymoFeature(p,"durationS",f);p.getParameter(ONSET).update(m)}b.updatePartOrder(ONSET_FEATURE)})};
DymoTemplates.createAchBachDymo=function(a){var c=a.getFeature(ONSET_FEATURE),b=a.getFeature(PITCH_FEATURE),e=a.getFeature(DURATION_FEATURE),d=a.getFeature("onsetS"),f=a.getFeature("durationS"),l=a.getFeature("time"),m=a.addDymo();a.setDymoFeature(m,c,0);a.setDymoFeature(m,b,0);a.setDymoFeature(m,e,0);$http.get("audio/achachbach10/01-AchGottundHerr.txt").success(function(k){k=k.split("\n");for(var h=0;h<k.length;h++)k[h]=k[h].split("\t");k.sort(function(a,g){return a[0]-g[0]});for(var n=[],h=0;h<
k.length;h++){var p=k[h][0],u=k[h][1],w=Number.parseInt(k[h][3]);if(n[w]){var v=n[w][0],q=u-n[w][2];k[v][4]=p-n[w][1];k[v][5]=q}n[w]=[h,p,u]}for(h=k.length-4;h<k.length;h++)k[h][4]=2700,k[h][5]=2700;for(h=0;h<k.length;h++)if(6==k[h].length){var n=k[h],p=Number.parseInt(n[2]),u=Number.parseInt(n[0])/1E3,w=Number.parseInt(n[1])/1E3,v=Number.parseInt(n[4])/1E3,q=Number.parseInt(n[5])/1E3,g;1==n[3]?g=a.addDymo(m,"audio/achachbach10/01-AchGottundHerr-violin.wav"):2==n[3]?g=a.addDymo(m,"audio/achachbach10/01-AchGottundHerr-clarinet.wav"):
3==n[3]?g=a.addDymo(m,"audio/achachbach10/01-AchGottundHerr-saxphone.wav"):4==n[3]&&(g=a.addDymo(m,"audio/achachbach10/01-AchGottundHerr-bassoon.wav"));a.setDymoFeature(g,b,p);a.setDymoFeature(g,l,u);a.setDymoFeature(g,c,u);a.setDymoFeature(g,e,v);a.setDymoFeature(g,d,w);a.setDymoFeature(g,f,q);g.getParameter(ONSET).update(u)}m.updatePartOrder(c.name)});$http.get("getsourcefilesindir/",{params:{directory:"audio/achachbach10/"}}).success(function(a){a=a.filter(function(a){return 0<=a.indexOf("wav")});
for(var b=0;b<a.length;b++)$scope.scheduler.addSourceFile("audio/achachbach10/"+a[b])})};function createRandomTriangle(){return[{0:Math.random(),1:Math.random()},{0:Math.random(),1:Math.random()},{0:Math.random(),1:Math.random()}]};function FeatureLoader(){function a(a,d,f,h){v(a,function(l){c(l,function(c){b(c,function(b){0<b.length?(m(a,d,f,b),h&&h()):e(c,function(b){var c=b.name;c||(c=a.split("_"),c=c[c.length-1].split(".")[0]);f.addFeature(c,b.values);h&&h()})})})})}function c(a,b){var c=N3.Store();N3.Parser().parse(a,function(a,g,d){g?c.addTriple(g):b(c)})}function b(a,c){for(var b=[],e=a.find(null,"http://purl.org/NET/c4dm/event.owl#time",null),h=0,k=e.length;h<k;h++){var m=d(a,e[h].object,"http://purl.org/NET/c4dm/timeline.owl#at");
m||(m=d(a,e[h].object,"http://purl.org/NET/c4dm/timeline.owl#beginsAt"));var n=d(a,e[h].object,"http://purl.org/NET/c4dm/timeline.owl#duration"),m={time:{value:l(m)},label:{value:f(d(a,e[h].subject,"http://www.w3.org/2000/01/rdf-schema#label"))}};n&&(m.duration={value:l(n)});b.push(m)}c(b)}function e(a,b){var c=f(d(a,null,"http://purl.org/dc/elements/1.1/title")),e=f(d(a,null,"http://purl.org/ontology/af/value")),e=e.split(" ").map(function(a){return parseFloat(a)}),h=f(d(a,null,"http://purl.org/ontology/af/dimensions")),
h=h.split(" ").map(function(a){return Number.parseInt(a)}),k=d(a,null,"http://purl.org/ontology/vamp/computed_by"),m=l(d(a,k,"http://purl.org/ontology/vamp/step_size"));a=l(d(a,k,"http://purl.org/ontology/vamp/sample_rate"));for(var k=[],n=0;n<e.length;){for(var p=[],q=0;q<h[0];q++)p[q]=e[n+q];k.push({time:{value:n*m/a},value:p});n+=h[0]}b({name:c,values:k})}function d(a,b,c){a=a.find(b,c,null);if(0<a.length)return a[0].object}function f(a){if(a)return N3.Util.getLiteralValue(a)}function l(a){a=N3.Util.getLiteralValue(a);
"P"==a.charAt(0)&&(a=a.substring(2,a.length-1));return Number(a)}function m(a,b,c,d){q[a]=d.sort(function(a,b){return a.time.value-b.time.value});d=q[a];b&&q[a][0].label&&(d=d.filter(function(a){return a.label.value==b}));c.addSegmentation(d)}function k(a,b,c,d){v(a,function(a){h(JSON.parse(a),b,c,d)})}function h(a,b,c,d){"file_metadata"==Object.keys(a)[0]?n(a,b,c,d):p(a,b,c,d)}function n(a,b,c,d){a=a[Object.keys(a)[1]][0];var e=a.annotation_metadata.annotator.output_id;"beats"==e||"onsets"==e?(a=
a.data,b&&a[0].label&&(a=a.filter(function(a){return a.label.value==b})),c.addSegmentation(a)):c.addFeature(e,a.data);d&&d()}function p(a,b,c,d){var e=a["@type"];"afv:BarandBeatTracker"==e||"afv:Onsets"==e?(a=a["afo:values"],b&&a[0]["afo:value"]&&(a=a.filter(function(a){return a["afo:value"]==b})),a=u(a),c.addSegmentation(a)):(a=w(a["afo:values"]),c.addFeature(e,a));d&&d()}function u(a){for(var b=[],c=0;c<a.length;c++)b.push({time:{value:a[c]["tl:at"]},label:{value:a[c]["afo:value"]}});return b}function w(a){for(var b=
[],c=0;c<a.length;c++)b.push({time:{value:a[c]["tl:at"]},value:[a[c]["afo:value"]]});return b}function v(a,c){var b=new XMLHttpRequest;b.addEventListener("load",function(){console.log("loaded "+a);c(this.responseText)});b.addEventListener("error",function(){console.log("loading "+a+" failed");c(this.responseText)});b.open("GET",a);b.send()}var q={};this.loadFeature=function(b,c,d,e){if(b.constructor==Object)h(b,c,d,e);else{var f=b.split("."),f=f[f.length-1];"n3"==f?a(b,c,d,e):"json"==f&&k(b,c,d,e)}}}
;var MEAN="mean",MEDIAN="median",FIRST="first";function Similarity(){}Similarity.addSimilaritiesTo=function(a){var c=a.getDymoMap();for(a=[a];0<a.length;){if(1<a.length){var b=Similarity.toVectors(a),b=Similarity.getCosineSimilarities(b);Similarity.addHighestSimilarities(c,b,a.length)}a=Similarity.getAllParts(a)}};Similarity.addSimilaritesAbove=function(a,c,b){for(var e in c)for(var d in c[e])c[e][d]>b&&(a[e].addSimilar(a[d]),a[d].addSimilar(a[e]))};
Similarity.addHighestSimilarities=function(a,c,b){var e=[],d;for(d in c)for(var f in c[d])e.push([c[d][f],d,f]);e=e.sort(function(a,b){return b[0]-a[0]});c=0;for(b=Math.min(e.length,b);c<b;c++)d=e[c],a[d[1]].addSimilar(a[d[2]]),a[d[2]].addSimilar(a[d[1]])};Similarity.getAllParts=function(a){for(var c=[],b=0,e=a.length;b<e;b++)Array.prototype.push.apply(c,a[b].getParts());return c};
Similarity.toVectors=function(a,c){for(var b={},e=[],d=0,f=a.length;d<f;d++){for(var l=[],m=a[d].getFeatures(),k=Object.keys(m),h=0,n=k.length;h<n;h++){var p=m[k[h]];c&&1<p.length&&(p=Similarity.reduce(p));e[h]=e[h]?Math.max(p,e[h]):p;1<p.length?Array.prototype.push.apply(l,p):l.push(p)}b[a[d].getUri()]=l}d=0;for(f=a.length;d<f;d++)for(l=b[a[d].getUri()],h=0,n=l.length;h<n;h++)e[h]&&(l[h]/=e[h]);return b};
Similarity.reduce=function(a){var c=Array.apply(null,Array(a.length)).map(Number.prototype.valueOf,1);return Similarity.getCosineSimilarity(a,c)};Similarity.getCosineSimilarities=function(a){var c={},b;for(b in a)for(var e in a)b<e&&(c[b]||(c[b]={}),c[b][e]=Similarity.getCosineSimilarity(a[b],a[e]));return c};Similarity.getCosineSimilarity=function(a,c){return math.dot(a,c)/math.norm(a)/math.norm(c)};
